<?php

// Process pages of contents and extract individual articles

require_once(dirname(__FILE__) . '/lib.php');

require_once 'vendor/autoload.php';
use Sunra\PhpSimple\HtmlDomParser;

$use_biotaxa = false; // Use mapress.com by default
$use_biotaxa = true; // Sometimes www.mapress.com doesn't have refs but www.biotaxa.org does!?

$basedir = dirname(__FILE__) . '/articles';
$sourcedir = dirname(__FILE__) . '/contents';

$files = scandir($sourcedir);

// debugging
//$files=array('2441.1.html');
//$files=array('4592.1.html');
//$files=array('3928.1.html');

$files=array('3905.1.html');

$files=array(
/*"3252.1.html",
"3635.3.html",
"3635.4.html",
"3635.5.html",
"3636.1.html",
"3636.2.html",
"3636.3.html",
"3636.4.html",
"3637.1.html",
"3637.2.html",
"3637.3.html",
"3637.4.html",
"3637.5.html",
"3638.1.html",
"3639.1.html",
"3640.1.html",
"3640.2.html",
"3640.3.html",
"3640.4.html",
"3641.1.html",
"3641.2.html",
"3641.3.html",
"3641.4.html",
"3641.5.html",
"3642.1.html",
"3643.1.html",
"3644.1.html",
"3645.1.html",
"3646.1.html",
"3646.2.html",
"3646.3.html",
"3646.4.html",
"3646.5.html",
"3647.1.html",
"3647.2.html",
"3647.3.html",
"3647.4.html",
"3648.1.html",
"3649.1.html",
"3650.1.html",
"3651.1.html",
"3652.1.html",
"3652.2.html",
"3652.3.html",
"3652.4.html",
"3652.5.html",
"3653.1.html",
"3654.1.html",
"3655.1.html",
"3656.1.html",
"3657.1.html",
"3658.1.html",
"3659.1.html",
"3660.1.html",
"3661.1.html",
"3662.1.html",
"3663.1.html",
"3664.1.html",
"3664.2.html",
"3664.3.html",
"3664.4.html",
"3665.1.html",
"3666.1.html",
"3666.2.html",
"3666.3.html",
"3666.4.html",
"3667.1.html",
"3668.1.html",
"3669.1.html",
"3669.2.html",
"3669.3.html",
"3669.4.html",
"3670.1.html",
"3670.2.html",
"3670.3.html",
"3670.4.html",
"3671.1.html",
"3672.1.html",
"3673.1.html",
"3674.1.html",
"3675.1.html",
"3676.1.html",
"3677.1.html",
"3678.1.html",
"3679.1.html",
"3680.1.html",
"3681.1.html",
"3681.2.html",
"3681.3.html",
"3681.4.html",
"3681.5.html",
"3682.1.html",
"3682.2.html",
"3682.3.html",
"3682.4.html",
"3683.1.html",
"3683.2.html",
"3683.3.html",
"3683.4.html",
"3683.5.html",
"3684.1.html",
"3685.1.html",
"3686.1.html",
"3686.2.html",
"3686.3.html",
"3686.4.html",
"3686.5.html",
"3687.1.html",
"3688.1.html",
"3689.1.html",
"3690.1.html",
"3691.1.html",
"3691.2.html",
"3691.3.html",
"3691.4.html",
"3691.5.html",
"3692.1.html",
"3693.1.html",
"3693.2.html",
"3693.3.html",
"3693.4.html",
"3694.1.html",
"3694.2.html",
"3694.3.html",
"3694.4.html",
"3694.5.html",
"3694.6.html",
"3695.1.html",
"3696.1.html",
"3697.1.html",
"3698.1.html",
"3699.1.html",
"3700.1.html",
"3700.2.html",
"3700.3.html",
"3700.4.html",
"3701.1.html",
"3701.2.html",
"3701.3.html",
"3701.4.html",
"3701.5.html",
"3702.1.html",
"3702.2.html",
"3702.3.html",
"3702.4.html",
"3702.5.html",
"3702.6.html",
"3703.1.html",
"3704.1.html",
"3705.1.html",
"3706.1.html",
"3707.1.html",
"3708.1.html",
"3709.1.html",
"3709.2.html",
"3709.3.html",
"3709.4.html",
"3709.5.html",
"3709.6.html",
"3710.1.html",
"3710.2.html",
"3710.3.html",
"3710.4.html",
"3710.5.html",
"3710.6.html",
"3711.1.html",
"3712.1.html",
"3713.1.html",
"3714.1.html",
"3715.1.html",
"3716.1.html",
"3716.2.html",
"3716.3.html",
"3716.4.html",
"3717.1.html",
"3717.2.html",
"3717.3.html",
"3717.4.html",
"3718.1.html",
"3718.2.html",
"3718.3.html",
"3718.4.html",
"3718.5.html",
"3718.6.html",
"3719.1.html",
"3720.1.html",
"3721.1.html",
"3721.2.html",
"3721.3.html",
"3721.4.html",
"3721.5.html",
"3721.6.html",
"3722.1.html",
"3722.2.html",
"3722.3.html",
"3722.4.html",
"3723.1.html",
"3724.1.html",
"3725.1.html",
"3726.1.html",
"3727.1.html",
"3728.1.html",
"3729.1.html",
"3730.1.html",
"3731.1.html",
"3731.2.html",
"3731.3.html",
"3731.4.html",
"3732.1.html",
"3733.1.html",
"3734.1.html",
"3734.2.html",
"3734.3.html",
"3734.4.html",
"3734.5.html",
"3735.1.html",
"3736.1.html",
"3736.2.html",
"3736.3.html",
"3736.4.html",
"3736.5.html",
"3737.1.html",
"3737.2.html",
"3737.3.html",
"3737.4.html",
"3737.5.html",
"3738.1.html",
"3739.1.html",
"3740.1.html",
"3741.1.html",
"3741.2.html",
"3741.3.html",
"3741.4.html",
"3742.1.html",
"3743.1.html",
"3744.1.html",
"3745.1.html",
"3745.2.html",
"3745.3.html",
"3745.4.html",
"3745.5.html",
"3746.1.html",
"3746.2.html",
"3746.3.html",
"3746.4.html",
"3747.1.html",
"3748.1.html",
"3749.1.html",
"3750.1.html",
"3750.2.html",
"3750.3.html",
"3750.4.html",
"3750.5.html",
"3751.1.html",
"3753.1.html",
"3753.2.html",
"3753.3.html",
"3753.4.html",
"3753.5.html",
"3753.6.html",
"3754.1.html",
"3754.2.html",
"3754.3.html",
"3754.4.html",
"3754.5.html",
"3755.1.html",
"3755.2.html",
"3755.3.html",
"3755.4.html",
"3755.5.html",
"3755.6.html",
"3756.1.html",
"3757.1.html",
"3758.1.html",
"3759.1.html",
"3760.1.html",
"3760.2.html",
"3760.3.html",
"3760.4.html",
"3761.1.html",
"3762.1.html",
"3763.1.html",
"3764.1.html",
"3764.2.html",
"3764.3.html",
"3764.4.html",
"3764.5.html",
"3765.1.html",
"3765.2.html",
"3765.3.html",
"3765.4.html",
"3765.5.html",
"3765.6.html",
"3766.1.html",
"3767.1.html",
"3768.1.html",
"3768.2.html",
"3768.3.html",
"3768.4.html",
"3768.5.html",
"3769.1.html",
"3770.1.html",
"3771.1.html",
"3772.1.html",
"3773.1.html",
"3774.1.html",
"3774.2.html",
"3774.3.html",
"3774.4.html",
"3774.5.html",
"3774.6.html",
"3775.1.html",
"3776.1.html",
"3777.1.html",
"3778.1.html",
"3779.1.html",
"3779.2.html",
"3779.3.html",
"3779.4.html",
"3779.5.html",
"3780.1.html",
"3780.2.html",
"3780.3.html",
"3781.1.html",
"3782.1.html",
"3783.1.html",
"3784.1.html",
"3784.2.html",
"3784.3.html",
"3784.4.html",
"3784.5.html",
"3785.1.html",
"3785.2.html",
"3785.3.html",
"3785.4.html",
"3786.1.html",
"3786.2.html",
"3786.3.html",
"3786.4.html",
"3786.5.html",
"3787.1.html",
"3788.1.html",
"3789.1.html",
"3790.1.html",
"3790.2.html",
"3790.3.html",
"3790.4.html",
"3791.1.html",*/

//"3792.2.html",

"3793.1.html",
"3793.2.html",
"3793.3.html",
"3793.4.html",
"3793.5.html",
"3794.1.html",
"3794.2.html",
"3794.3.html",
"3794.4.html",
"3795.1.html",
"3795.2.html",
"3795.3.html",
"3795.4.html",
"3795.5.html",
"3796.1.html",
"3796.2.html",
"3796.3.html",
"3797.1.html",
"3798.1.html",
"3799.1.html",
"3800.1.html",
"3801.1.html",
"3802.1.html",
"3802.2.html",
"3802.3.html",
"3802.4.html",
"3803.1.html",
"3804.1.html",
"3805.1.html",
"3806.1.html",
"3807.1.html",
"3808.1.html",
"3809.1.html",
"3810.1.html",
"3811.1.html",
"3811.2.html",
"3811.3.html",
"3811.4.html",
"3812.1.html",
"3813.1.html",
"3814.1.html",
"3814.2.html",
"3814.3.html",
"3814.4.html",
"3815.1.html",
"3815.2.html",
"3815.3.html",
"3815.4.html",
"3816.1.html",
"3817.1.html",
"3818.1.html",
"3819.1.html",
"3820.1.html",
"3821.1.html",
"3821.2.html",
"3821.3.html",
"3821.4.html",
"3821.5.html",
"3822.1.html",
"3823.1.html",
"3824.1.html",
"3825.1.html",
"3826.1.html",
"3826.2.html",
"3826.3.html",
"3827.1.html",
"3827.2.html",
"3827.3.html",
"3827.4.html",
"3828.1.html",
"3829.1.html",
"3830.1.html",
"3831.1.html",
"3832.1.html",
"3833.1.html",
"3834.1.html",
"3835.1.html",
"3835.2.html",
"3835.3.html",
"3835.4.html",
"3836.1.html",
"3837.1.html",
"3838.1.html",
"3838.2.html",
"3838.3.html",
"3838.4.html",
"3838.5.html",
"3839.1.html",
"3840.1.html",
"3841.1.html",
"3841.2.html",
"3841.3.html",
"3841.4.html",
"3842.1.html",
"3843.1.html",
"3844.1.html",
"3845.1.html",
"3846.1.html",
"3846.2.html",
"3846.3.html",
"3846.4.html",
"3847.1.html",
"3847.2.html",
"3847.3.html",
"3847.4.html",
"3848.1.html",
"3849.1.html",
"3850.1.html",
"3851.1.html",
"3852.1.html",
"3852.2.html",
"3852.3.html",
"3852.4.html",
"3852.5.html",
"3853.1.html",
"3854.1.html",
"3855.1.html",
"3856.1.html",
"3856.2.html",
"3856.3.html",
"3856.4.html",
"3857.1.html",
"3857.2.html",
"3857.3.html",
"3857.4.html",
"3858.1.html",
"3859.1.html",
"3860.1.html",
"3860.2.html",
"3860.3.html",
"3860.4.html",
"3860.5.html",
"3860.6.html",
"3861.1.html",
"3861.2.html",
"3861.3.html",
"3861.4.html",
"3861.5.html",
"3861.6.html",
"3862.1.html",
"3863.1.html",
"3864.1.html",
"3865.1.html",
"3866.1.html",
"3866.2.html",
"3866.3.html",
"3866.4.html",
"3867.1.html",
"3868.1.html",
"3869.1.html",
"3869.2.html",
"3869.3.html",
"3869.4.html",
"3869.5.html",
"3870.1.html",
"3871.1.html",
"3872.1.html",
"3872.2.html",
"3872.3.html",
"3872.4.html",
"3872.5.html",
"3873.1.html",
"3873.2.html",
"3873.3.html",
"3873.4.html",
"3873.5.html",
"3874.1.html",
"3875.1.html",
"3876.1.html",
"3877.1.html",
"3878.1.html",
"3878.2.html",
"3878.3.html",
"3878.4.html",
"3878.5.html",
"3878.6.html",
"3879.1.html",
"3880.1.html",
"3881.1.html",
"3881.2.html",
"3881.3.html",
"3881.4.html",
"3881.5.html",
"3881.6.html",
"3882.1.html",
"3883.1.html",
"3884.1.html",
"3884.2.html",
"3884.3.html",
"3884.4.html",
"3884.5.html",
"3884.6.html",
"3885.1.html",
"3886.1.html",
"3887.1.html",
"3887.2.html",
"3887.3.html",
"3887.4.html",
"3887.5.html",
"3888.1.html",
"3889.1.html",
"3889.2.html",
"3889.3.html",
"3889.4.html",
"3890.1.html",
"3891.1.html",
"3892.1.html",
"3893.1.html",
"3893.2.html",
"3893.3.html",
"3893.4.html",
"3894.1.html",
"3895.1.html",
"3895.2.html",
"3895.3.html",
"3895.4.html",
"3896.1.html",
"3897.1.html",
"3898.1.html",
"3899.1.html",
"3900.1.html",
"3900.2.html",
"3900.3.html",
"3900.4.html",
"3901.1.html",
"3902.1.html",
"3903.1.html",
"3904.1.html",
"3904.2.html",
"3904.3.html",
"3904.4.html",
"3905.2.html",
"3905.3.html",
"3905.4.html",
"3907.1.html",
"3908.1.html",
"3909.1.html",
"3910.1.html",
"3911.1.html",
"3911.2.html",
"3911.3.html",
"3911.4.html",
"3912.1.html",
"3913.1.html",
"3914.1.html",
"3914.2.html",
"3914.3.html",
"3914.4.html",
"3914.5.html",
"3915.1.html",
"3915.2.html",
"3915.3.html",
"3915.4.html",
"3916.1.html",
"3917.1.html",
"3918.1.html",
"3918.2.html",
"3918.3.html",
"3918.4.html",
"3919.1.html",
"3919.2.html",
"3919.3.html",
"3920.1.html",
"3920.2.html",
"3920.3.html",
"3920.4.html",
"3921.1.html",
"3922.1.html",
"3923.1.html",
"3924.1.html",
"3925.1.html",
"3925.2.html",
"3925.3.html",
"3925.4.html",
"3926.1.html",
"3926.2.html",
"3926.3.html",
"3926.4.html",
"3927.1.html",
"3931.1.html",
"3931.2.html",
"3931.3.html",
"3931.4.html",
"3932.1.html",
"3933.1.html",
"3934.1.html",
"3935.1.html",
"3936.1.html",
"3936.2.html",
"3936.3.html",
"3936.4.html",
"3937.1.html",
"3937.2.html",
"3937.3.html",
"3938.1.html",
"3939.1.html",
"3940.1.html",
"3941.1.html",
"3941.2.html",
"3941.3.html",
"3941.4.html",
"3942.1.html",
"3943.1.html",
"3944.1.html",
"3945.1.html",
"3946.1.html",
"3946.2.html",
"3946.3.html",
"3946.4.html",
"3947.1.html",
"3947.2.html",
"3947.3.html",
"3947.4.html",
"3948.1.html",
"3948.2.html",
"3948.3.html",
"3949.1.html",
"3949.2.html",
"3949.3.html",
"3949.4.html",
"3950.1.html",
"3951.1.html",
"3952.1.html",
"3953.1.html",
"3954.1.html",
"3955.1.html",
"3955.2.html",
"3955.3.html",
"3955.4.html",
"3956.1.html",
"3956.2.html",
"3956.3.html",
"3956.4.html",
"3957.1.html",
"3957.2.html",
"3957.3.html",
"3957.4.html",
"3957.5.html",
"3958.1.html",
"3959.1.html",
"3960.1.html",
"3961.1.html",
"3962.1.html",
"3963.1.html",
"3963.2.html",
"3963.3.html",
"3963.4.html",
"3964.1.html",
"3964.2.html",
"3964.3.html",
"3964.4.html",
"3964.5.html",
"3965.1.html",
"3966.1.html",
"3967.1.html",
"3968.1.html",
"3969.1.html",
"3970.1.html",
"3971.1.html",
"3972.1.html",
"3972.2.html",
"3972.3.html",
"3972.4.html",
"3973.1.html",
"3973.2.html",
"3973.3.html",
"3974.1.html",
"3974.2.html",
"3974.3.html",
"3974.4.html",
"3975.1.html",
"3977.1.html",
"3979.1.html",
"3980.1.html",
"3980.2.html",
"3980.3.html",
"3980.4.html",
"3981.1.html",
"3981.2.html",
"3981.3.html",
"3981.4.html",
"3982.1.html",
"3983.1.html",
"3984.1.html",
"3985.1.html",
"3985.2.html",
"3985.4.html",
"3986.1.html",
"3986.2.html",
"3986.3.html",
"3986.4.html",
"3986.5.html",
"3987.1.html",
"3988.1.html",
"3989.1.html",
"3990.1.html",
"3990.2.html",
"3990.3.html",
"3990.4.html",
"3991.1.html",
"3992.1.html",
"3993.1.html",
"3994.1.html",
"3994.2.html",
"3994.3.html",
"3994.4.html",
"3995.1.html",
"3996.1.html",
"3997.1.html",
"3998.1.html",
"3999.1.html",
"3999.2.html",
"3999.3.html",
"3999.4.html",
"4000.2.html",
"4000.3.html",
"4000.4.html",
"4000.5.html",
"4001.1.html",
"4002.1.html",
"4003.1.html",
"4004.1.html",
"4005.1.html",
"4006.1.html",
"4006.2.html",
"4006.3.html",
"4007.1.html",
"4007.2.html",
"4007.3.html",
"4007.4.html",
"4008.1.html",
"4009.1.html",
"4010.1.html",
"4011.1.html",
"4012.1.html",
"4012.2.html",
"4012.3.html",
"4013.1.html",
"4013.2.html",
"4013.3.html",
"4013.4.html",
"4014.1.html",
"4015.1.html",
"4016.1.html",
"4017.1.html",
"4018.1.html",
"4018.2.html",
"4018.3.html",
"4018.4.html",
"4019.1.html",
"4020.1.html",
"4020.2.html",
"4020.3.html",
"4021.1.html",
"4021.3.html",
"4021.4.html",
"4022.1.html",
"4023.1.html",
"4024.1.html",
"4025.1.html",
"4026.1.html",
"4027.1.html",
"4027.2.html",
"4027.3.html",
"4027.4.html",
"4028.1.html",
"4028.2.html",
"4028.3.html",
"4028.4.html",
"4029.1.html",
"4030.1.html",
"4031.1.html",
"4032.1.html",
"4032.2.html",
"4032.3.html",
"4032.4.html",
"4032.5.html",
"4033.1.html",
"4033.2.html",
"4033.3.html",
"4033.4.html",
"4034.1.html",
"4034.2.html",
"4034.3.html",
"4035.1.html",
"4037.1.html",
"4038.1.html",
"4039.1.html",
"4039.2.html",
"4039.3.html",
"4039.4.html",
"4040.1.html",
"4040.2.html",
"4040.3.html",
"4040.4.html",
"4040.5.html",
"4041.1.html",
"4042.1.html",
"4043.1.html",
"4044.1.html",
"4044.2.html",
"4044.3.html",
"4044.4.html",
"4045.1.html",
"4046.1.html",
"4047.1.html",
"4048.1.html",
"4048.2.html",
"4048.3.html",
"4048.4.html",
"4049.1.html",
"4050.1.html",
"4051.1.html",
"4052.1.html",
"4052.2.html",
"4052.3.html",
"4052.4.html",
"4052.5.html",
"4053.1.html",
"4054.1.html",
"4055.1.html",
"4056.1.html",
"4057.1.html",
"4057.2.html",
"4057.3.html",
"4057.4.html",
"4058.1.html",
"4058.2.html",
"4058.3.html",
"4058.4.html",
"4059.1.html",
"4059.2.html",
"4059.3.html",
"4060.1.html",
"899.1.html",
"917.1.html"
);


$count = 1;


foreach ($files as $filename)
{
	// echo "filename=$filename\n";
	
	if (preg_match('/\.html$/', $filename))
	{	
		$html = file_get_contents($sourcedir . '/' . $filename);
		
		$dom = HtmlDomParser::str_get_html($html);
		
		foreach ($dom->find('div[class=tocTitle] a') as $a)
		{
			echo $a->href . "\n";
			
			$url = $a->href;
			
			$ok = true;
			
			// https://www.mapress.com/j/zt/article/view/7515
			if (preg_match('/view\/\d+$/', $url))
			{
				$ok = false;
			}
			
			if (preg_match('/@/', $url))
			{
				$ok = false;
			}

			if (preg_match('/web.ebscohost.com/', $url))
			{
				$ok = false;
			}
			
				
			if ($ok)
			{
				echo $url . "\n";
				
				$filename = preg_replace('/https?:\/\/www.mapress.com\/j\/zt\/article\/view\/z?o?o+tr?[a|z]xz?a?\.?/i', '', $url);

				$filename = preg_replace('/https?:\/\/www.mapress.com\/j\/zt\/article\/view\//i', '', $filename);
				
				// https://www.mapress.com/j/zt/article/view/1%E2%80%9391
				$filename = urldecode($filename);
				
				$filename .= '.html';
				
				echo $filename . "\n";
			
				if (preg_match('/^(?<volume>\d+)(–\d+)?\.?/u', $filename, $m))
				{
					$volume = $m['volume'];
				
					// folder for volume
				
					$dir = $basedir . '/' . $volume ;
					if (!file_exists($dir))
					{
						$oldumask = umask(0); 
						mkdir($dir, 0777);
						umask($oldumask);
					}
	
					$filename = $dir . '/' . $filename;
				
					if (file_exists($filename))
					{
						echo "Have it\n";
					}
					else 
					{
						if ($use_biotaxa)
						{
							$url = preg_replace('/https?:\/\/www.mapress.com\/j\/zt\//', 'https://www.biotaxa.org/Zootaxa/', $url);
						}				
				
						$article = get($url);
			
						file_put_contents($filename, $article);
			
						// Give server a break every 10 items
						if (($count++ % 10) == 0)
						{
							$rand = rand(1000000, 3000000);
							echo "\n ...sleeping for " . round(($rand / 1000000),2) . ' seconds' . "\n\n";
							usleep($rand);
						}
					}
				
				
				}
				else
				{
					echo "Problem\n";
					exit();
				}
			}
			
		}
		
	}

}

		
?>

